{% extends "smartmin/read.html" %}
{% load smartmin sms temba contacts i18n %}

{% block extra-style %}
  {{ block.super }}
  <style type="text/css">
    .modal .modal-body {
      max-height: 450px;
    }

    #engagement-charts {
      justify-content: center;
      padding-top: 2em;
    }

    #engagement-charts>div {
      margin-bottom: 6em;
      align-self: flex-start;
      flex-basis: 400px;
    }

    h4 {
      font-weight: 300;
      text-align: center;
    }
  </style>
{% endblock extra-style %}
{% block extra-script %}
  {{ block.super }}
  <script type="text/javascript">
    function handleFlowRefreshed(evt) {
      var flow = evt.detail.data;
      if (flow.runs) {
        var runCount = flow.runs.active + flow.runs.completed + flow.runs.expired + flow.runs.interrupted;

        var tabs = document.querySelector("temba-tabs");
        var runsTab = tabs.getTab(2);
        if (runsTab) {
          runsTab.count = runCount;
          tabs.requestUpdate();

          var runList = document.querySelector("temba-run-list");
          runList.results = flow.results;
        }
      }
    }

    function handleRunsRefreshed(evt) {
      document.querySelector("temba-flow-details").refresh();
    }

    function updateEngagement() {
      fetchAjax("{% url 'flows.flow_engagement' object.id %}", {
        container: "#engagement-charts"
      });
    }

    function handleTabChanged() {
      var tabs = document.querySelector("temba-tabs");
      if (!tabs) {
        return;
      }

      // runs are paused unless our tab is active
      var runs = document.querySelector("temba-run-list");
      if (runs) {
        runs.paused = tabs.index != 2;
      }
    }

    onSpload(function() {
      updateEngagement();
    });
  </script>
{% endblock extra-script %}
{% block content %}
  <temba-flow-details flow="{{ object.uuid }}" -temba-refreshed="handleFlowRefreshed">
  </temba-flow-details>
  <temba-tabs -temba-context-changed="handleTabChanged"
              collapses="true"
              class="flex-grow"
              index="{{ request.GET.tab }}">
    <temba-tab name="{{ _("Engagement") |escapejs }}" icon="overview">
      <div class="flex flex-wrap overflow-y-scroll overflow-x-hidden" id="engagement-charts"></div>
    </temba-tab>
    <temba-tab name="{{ _("Analytics") |escapejs }}" icon="analytics">
      <div class="flex flex-wrap overflow-y-scroll overflow-x-hidden p-4">
        {% for result in category_counts %}
          <temba-chart header="{{ result.name }}"
                       url="{% url 'flows.flow_chart' object.id result.key %}"
                       dataname="Categories"
                       config
                       legend
                       class="mb-6 mr-6"
                       style="min-width: 400px;">
          </temba-chart>
        {% endfor %}
      </div>
    </temba-tab>
    <temba-tab name="{{ _("Runs") |escapejs }}" icon="runs">
      <temba-run-list flow="{{ object.uuid }}"
                      -temba-refreshed="handleRunsRefreshed"
                      class="p-4 flex flex-col flex-grow overflow-hidden">
      </temba-run-list>
    </temba-tab>
  </temba-tabs>
{% endblock content %}
